# Основни функционалности - Bash Inv Web Електронно Фактуриране

## Съдържание

1. [Управление на документи](#управление-на-документи)
2. [Управление на клиенти](#управление-на-клиенти)
3. [VIES Интеграция](#vies-интеграция)
4. [Многовалутна система](#многовалутна-система)
5. [Артикули и услуги](#артикули-и-услуги)
6. [Плащания и банкови сметки](#плащания-и-банкови-сметки)
7. [Проследяване на плащания](#проследяване-на-плащания)
8. [PDF Генериране](#pdf-генериране)
9. [Валидатор на документи](#валидатор-на-документи)
10. [Справки и отчети](#справки-и-отчети)
11. [Управление на фирми](#управление-на-фирми)
    - [Смяна на активна фирма (Multi-Company)](#смяна-на-активна-фирма-multi-company-support)
    - [Профил на фирмата](#профил-на-фирмата)
12. [Потребители и роли](#потребители-и-роли)
13. [Dashboard и статистики](#dashboard-и-статистики)

---

## Управление на документи

### Типове документи

Системата поддържа четири основни типа документи:

#### 1. INVOICE (Фактура)
- Основен данъчен документ
- Издава се при продажба на стоки или услуги
- Задължителна за ДДС регистрирани фирми
- Автоматично номериране без пропуски

#### 2. CREDIT_NOTE (Кредитно известие)
- Данъчен документ за намаляване на данъчна основа
- Използва се при:
  - Връщане на стоки
  - Намаляване на цена след издаване на фактура
  - Отстъпки след издаване на фактура
  - Корекция на грешни данни във фактура

#### 3. DEBIT_NOTE (Дебитно известие)
- Данъчен документ за увеличение на данъчна основа
- Използва се при:
  - Допълнителни такси след издаване на фактура
  - Увеличение на цена
  - Корекция на грешно изчислен ДДС

#### 4. PROFORMA (Проформа фактура)
- Неданъчен документ (не се отчита пред НАП)
- Използва се за:
  - Предварителни оферти
  - Заявки
  - Ценови запитвания
- Може да бъде преобразувана във фактура

### Статуси на документи

**DRAFT (Чернова)**
- Документът е в работа
- Може да се редактира свободно
- Не се брои в данъчната отчетност
- Може да се изтрие

**FINAL (Приключен)**
- Документът е финализиран
- Получава окончателен номер в последователността
- Отчита се в данъчната отчетност
- Не може да се изтрие (само VOID)
- Може да се върне към DRAFT статус за корекции

### Създаване на документ

#### Стъпка 1: Избор на клиент

От страницата **Documents** кликнете бутона **Create Document**.

Имате три опции за избор на клиент:

1. **Съществуващ клиент:** Изберете от dropdown списъка
2. **Нов клиент (обикновен):** Бутон "Add New Client"
3. **Нов клиент (VIES):** Бутон "Search EU Client" - автоматично попълване

#### Стъпка 2: Основна информация

Попълнете следните полета:

- **Тип документ:** INVOICE / CREDIT_NOTE / DEBIT_NOTE / PROFORMA
- **Номер:** Автоматично генериран (може да се промени за DRAFT)
- **Дата на издаване:** По подразбиране днес
- **Дата на данъчно събитие:** За ДДС отчитането (обикновено същата като издаването)
- **Срок на плащане:** Дни до падежа (по подразбиране от фирмата)
- **Валута:** BGN, EUR, USD, GBP и др.

#### Стъпка 3: Добавяне на артикули

За всеки артикул попълнете:

- **Име:** Описание на артикула/услугата
- **Количество:** Брой/бройки
- **Единица:** бр., кг, л, м, м², часа и др.
- **Единична цена:** Цена без ДДС
- **ДДС ставка:** 20%, 9%, 0%
- **Отстъпка:** % или фиксирана сума (опционално)

**Автоматични изчисления:**
- Междинна сума (без ДДС)
- ДДС сума
- Обща сума (с ДДС)
- Левова равностойност (ако не е BGN)

#### Стъпка 4: Плащане и банкова сметка

- **Метод на плащане:** CASH / BANK_TRANSFER / CARD / PAYPAL
- **Банкова сметка:** Изберете сметка (ако е нужна за метода на плащане)

#### Стъпка 5: Допълнителна информация (опционално)

- **Забележки:** Вътрешни бележки (не се показват на клиента)
- **Долен текст:** Текст в подножието на документа
- **Съставител:** Име на лицето, което съставя документа

#### Стъпка 6: Запазване

Два варианта:

- **Save as Draft:** Запазва документа като чернова
- **Finalize:** Запазва документа и го прави окончателен (FINAL статус)

### Редактиране на документ

#### Редактиране на DRAFT документ

1. Отидете на **Documents**
2. Кликнете върху документа
3. Кликнете **Edit**
4. Променете каквото желаете
5. Кликнете **Save** или **Finalize**

#### Редактиране на FINAL документ

FINAL документи не могат да се редактират директно. Имате две опции:

**Опция 1: Връщане към DRAFT**
1. Кликнете **Change Status** → **Set to Draft**
2. Редактирайте документа
3. Кликнете **Finalize** отново

**Опция 2: Издаване на кредитно/дебитно известие**
1. Създайте ново CREDIT_NOTE или DEBIT_NOTE
2. Въведете корекциите
3. Приключете документа

### Изтриване на документ

- **DRAFT документи:** Могат да се изтриват свободно
- **FINAL документи:** НЕ могат да се изтриват

Ако искате да "изтриете" FINAL документ:
1. Създайте CREDIT_NOTE с пълната сума
2. Документът остава в историята, но е неутрализиран

### Номериране

Системата автоматично номерира документите:

**Правила:**
- Отделни последователности за всеки тип документ
- Данъчни документи (INVOICE, CREDIT_NOTE, DEBIT_NOTE) имат една последователност
- Неданъчни документи (PROFORMA) имат отделна последователност
- Номерацията е без пропуски (изискване на НАП)
- Формат: 0000000001, 0000000002, и т.н.

**Преномериране:**
- DRAFT документи могат да имат временен номер
- При Finalize получават окончателен номер от последователността
- FINAL документи не могат да се преномерират

### Филтриране и търсене

От страницата **Documents** можете да филтрирате по:

- **Тип документ:** INVOICE / CREDIT_NOTE / DEBIT_NOTE / PROFORMA
- **Статус:** DRAFT / FINAL
- **Клиент:** Име на клиента
- **Период:** От дата - До дата
- **Валута:** BGN / EUR / USD и др.
- **Номер:** Точно търсене

---

## Управление на клиенти

### Типове клиенти

#### B2B (Business to Business)
- Юридически лица
- Задължителни полета: ЕИК, фирмено име
- Опционално: ДДС номер (ако е ДДС регистриран)
- За EU клиенти: VIES валидация

#### B2C (Business to Consumer)
- Физически лица
- Полета: Име, адрес, телефон
- Без ЕИК/ДДС номер

### Създаване на клиент

#### Метод 1: Ръчно въвеждане

1. Отидете на **Clients**
2. Кликнете **Add Client**
3. Попълнете данните:

**Основна информация:**
- Име на клиента (задължително)
- Тип: B2B / B2C
- ЕИК (за B2B)
- ДДС номер (опционално)
- Email
- Телефон

**Адрес:**
- Адрес 1 (задължително)
- Адрес 2 (опционално)
- Град
- Пощенски код
- Държава

**Платежни настройки:**
- Срок на плащане (дни)
- Кредитен лимит
- Отстъпка по подразбиране (%)

4. Кликнете **Save**

#### Метод 2: VIES автоматично попълване (само EU)

1. Отидете на **Clients**
2. Кликнете **Search EU Client**
3. Въведете ДДС номер (напр. BG123456789)
4. Кликнете **Search**
5. Системата автоматично попълва:
   - Име на фирмата
   - Адрес
   - Държава
   - Валидира ДДС номера
6. Допълнете останалите полета (email, телефон)
7. Кликнете **Create**

**Забележка:** VIES работи само за EU държави (вижте [VIES Интеграция](#vies-интеграция))

### Редактиране на клиент

1. Отидете на **Clients**
2. Кликнете върху клиента
3. Кликнете **Edit**
4. Променете данните
5. Кликнете **Save**

### Деактивиране на клиент

Вместо да изтривате клиент (което може да наруши връзки с документи):

1. Отворете клиента
2. Кликнете **Deactivate**
3. Клиентът няма да се показва в списъците (освен ако не филтрирате за "Inactive")

За активиране отново:
1. Филтрирайте за "Inactive" клиенти
2. Отворете клиента
3. Кликнете **Activate**

### Преглед на документи за клиент

1. Отворете клиента
2. Секция **Documents** показва всички документи за този клиент
3. Можете да филтрирате по тип и период

---

## VIES Интеграция

### Какво е VIES?

**VIES (VAT Information Exchange System)** е официалната система на Европейския съюз за проверка на валидността на ДДС номера на компании от различни EU държави.

### Защо е важно?

- **Автоматично попълване:** Спестява време при въвеждане на клиенти
- **Валидация:** Потвърждава че ДДС номерът е валиден и активен
- **Актуални данни:** Взима официални данни от регистрите на съответната държава
- **Съответствие:** Помага за спазване на изискванията за вътрешнообщностни доставки

### Как работи?

1. Въвеждате ДДС номер (напр. DE123456789)
2. Системата праща заявка към VIES API
3. VIES проверява в националния регистър на Германия
4. Връща данни: Име, адрес, статус на валидност
5. Системата автоматично попълва полетата

### Поддържани държави

Всички 27 EU държави:

| Код | Държава | Пример ДДС номер |
|-----|---------|------------------|
| AT | Австрия | ATU12345678 |
| BE | Белгия | BE0123456789 |
| BG | България | BG123456789 |
| CY | Кипър | CY12345678L |
| CZ | Чехия | CZ12345678 |
| DE | Германия | DE123456789 |
| DK | Дания | DK12345678 |
| EE | Естония | EE123456789 |
| ES | Испания | ESX12345678 |
| FI | Финландия | FI12345678 |
| FR | Франция | FR12345678901 |
| GR | Гърция | GR123456789 |
| HR | Хърватия | HR12345678901 |
| HU | Унгария | HU12345678 |
| IE | Ирландия | IE1234567L |
| IT | Италия | IT12345678901 |
| LT | Литва | LT123456789 |
| LU | Люксембург | LU12345678 |
| LV | Латвия | LV12345678901 |
| MT | Малта | MT12345678 |
| NL | Холандия | NL123456789B01 |
| PL | Полша | PL1234567890 |
| PT | Португалия | PT123456789 |
| RO | Румъния | RO12345678 |
| SE | Швеция | SE123456789001 |
| SI | Словения | SI12345678 |
| SK | Словакия | SK1234567890 |

### Използване на VIES

#### От страницата Clients

1. Кликнете **Search EU Client**
2. Въведете ДДС номер (с кода на държавата)
   - Пример 1: BG123456789
   - Пример 2: DE123456789
   - Пример 3: FR12345678901
3. Кликнете **Search**
4. Изчакайте 1-3 секунди
5. Ако номерът е валиден:
   - Виждате съобщение "Valid VAT number"
   - Полетата се попълват автоматично
6. Ако номерът е невалиден:
   - Виждате грешка "Invalid VAT number"
   - Проверете дали сте въвели правилния номер

#### От формата за създаване на документ

При създаване на нов документ:

1. Кликнете **Search EU Client** (вместо Add New Client)
2. Следвайте стъпките по-горе
3. След успешно търсене клиентът се създава и добавя към документа

### Fallback механизъм

VIES системата има два API:

1. **REST API** (основен)
2. **SOAP API** (резервен)

Ако REST API не работи, системата автоматично прави опит със SOAP API.

### Ограничения

**VIES работи само за EU държави!**

За non-EU клиенти (Великобритания, Швейцария, САЩ и др.):
- Използвайте обикновеното ръчно въвеждане
- VIES няма да работи за тях

**Временна недостъпност:**
- VIES API понякога е недостъпен (извън работно време, поддръжка)
- Системата показва подходящо съобщение
- Опитайте отново по-късно

### Кеширане

Резултатите от VIES се кешират за **30 минути**:

- Първата заявка за даден ДДС номер е към VIES
- Следващите заявки за същия номер идват от кеша
- След 30 минути кешът изтича и се прави нова заявка

**Предимства:**
- По-бързи повторни търсения
- Намалява натоварването на VIES API
- Спестява време

---

## Многовалутна система

### Поддържани валути

Системата поддържа всички основни световни валути:

- **EUR** - Евро (базова валута)
- **BGN** - Български лев
- **USD** - Американски долар
- **GBP** - Британска лира
- **CHF** - Швейцарски франк
- **JPY** - Японска йена
- **RUB** - Руска рубла
- **TRY** - Турска лира
- И много други...

### Валутни курсове

#### Източници на курсове

**ЕЦБ (Европейска централна банка)**
- Официални курсове на Еврозоната
- Актуализация: Всеки работен ден в 16:00 CET
- Всички курсове са спрямо EUR
- BGN фиксиран на 1.95583 към EUR

#### Автоматично изтегляне

Системата автоматично изтегля курсове от ЕЦБ всеки работен ден около 16:00 CET.

#### Ръчно изтегляне

#### Използване на валути в документи

1. При създаване на документ изберете **Currency**
2. Въведете цени в избраната валута
3. Системата автоматично:
   - Взима курса за датата на документа
   - Изчислява левовата равностойност
   - Записва exchangeRate в документа
4. **Важно:** За не-EUR валути, курсът и датата на курса се показват във формата за създаване на документ и в генерирания PDF.

#### Как се изчислява левовата равностойност?

Системата използва EUR като базова валута. Всички конверсии се правят първо към EUR, след което (ако е необходимо) към BGN.

```
1. Конвертираме валутата към EUR
   EUR равностойност = Сума във валута / Exchange Rate (към EUR)

2. Конвертираме EUR към BGN (ако е необходимо)
   BGN равностойност = EUR равностойност × 1.95583 (фиксиран курс)

Пример: 100 USD (Exchange Rate 0.89 EUR за 1 USD)
1. 100 USD / 0.89 = 112.36 EUR
2. 112.36 EUR × 1.95583 = 219.78 BGN
```

#### Какво ако няма курс за датата?

Системата интелигентно търси **най-близкия наличен курс**:

1. Проверява за точната дата
2. Ако няма → търси предишния работен ден
3. Продължава назад до намери курс
4. Максимум 10 дни назад

Пример:
- Документ с дата 01.01.2025 (Нова година - неработен ден)
- Системата ще използва курса от 31.12.2024

### Добавяне на нова валута

За администратори:

1. Отидете на **Company Settings** → **Currency**
2. Кликнете **Add Currency**
3. Попълнете:
   - Код: USD, GBP и др. (3 букви)
   - Име: United States Dollar
   - Символ: $
4. Кликнете **Save**
5. Кликнете **Fetch Latest Rates** за изтегляне на курс

---

## Артикули и услуги

### Какво са артикулите?

Артикулите са предварително дефинирани продукти или услуги, които често използвате във вашите документи.

**Предимства:**
- Бързо добавяне към документи
- Консистентност в цените
- Автоматично попълване на ДДС ставка
- Лесно управление на продуктов каталог

### Създаване на артикул

1. Отидете на **Items**
2. Кликнете **Add Item**
3. Попълнете данните:

**Основна информация:**
- **Номер:** Уникален номер/код (напр. SERV001)
- **Име (BG):** Име на български (задължително)
- **Име (EN):** Име на английски (опционално)
- **Описание:** Допълнително описание

**Ценообразуване:**
- **Единична цена:** Цена без ДДС
- **Валута:** Обикновено BGN
- **Единица:** бр., кг, л, м, часа и др.

**ДДС:**
- **ДДС ставка:** 20%, 9%, 0%
- **Освобождаване от ДДС:** Ако е приложимо (чл. 21, 22, 23 от ЗДДС)

**Счетоводство:**
- **Счетоводна сметка:** За интеграция със счетоводен софтуер

4. Кликнете **Save**

### Използване на артикул в документ

При създаване на документ:

1. В секцията **Document Items** кликнете **Add Item from Library**
2. Изберете артикул от списъка
3. Артикулът се добавя с предварително попълнени данни:
   - Име
   - Единична цена
   - ДДС ставка
   - Единица
4. Променете количеството според нуждите
5. При необходимост променете цената (за този конкретен документ)

### Редактиране на артикул

1. Отидете на **Items**
2. Кликнете върху артикула
3. Кликнете **Edit**
4. Променете данните
5. Кликнете **Save**

**Важно:** Промяната на артикул **не засяга** съществуващи документи. Засяга само новите документи.

### Деактивиране на артикул

Ако артикул вече не се предлага:

1. Отворете артикула
2. Кликнете **Deactivate**
3. Артикулът няма да се показва при избор (освен ако не филтрирате за "Inactive")

За активиране отново:
1. Филтрирайте за "Inactive" артикули
2. Отворете артикула
3. Кликнете **Activate**

---

## Плащания и банкови сметки

### Методи на плащане

Системата поддържа следните методи:

#### CASH (В брой)
- Плащане в кеш
- Не изисква банкова сметка

#### BANK_TRANSFER (Банков превод)
- Плащане по банкова сметка
- **Изисква** избор на банкова сметка
- Най-често използван метод

#### CARD (Картово плащане)
- Плащане с банкова карта
- Не изисква банкова сметка

#### PAYPAL
- Плащане през PayPal
- Не изисква банкова сметка

#### PAYBG (ПейБиГи)
- Плащане през системата ПейБиГи
- Не изисква банкова сметка

### Управление на методи на плащане

За администратори:

1. Отидете на **Company Settings** → **Payment Methods**
2. Виждате списък с всички методи
3. Можете да:
   - Активирате/Деактивирате метод
   - Задайте метод по подразбиране
   - Редактирате име (BG/EN)

### Банкови сметки

#### Добавяне на банкова сметка

1. Отидете на **Company Settings** → **Bank Accounts**
2. Кликнете **Add Bank Account**
3. Попълнете данните:

**Информация за сметката:**
- **Име на банката:** ОББ, Уникредит Булбанк и др.
- **IBAN:** BGXX XXXX XXXX XXXX XXXX XX
- **BIC/SWIFT:** 8-11 знака
- **Валута:** BGN, EUR, USD и др.

**Описателна информация:**
- **Account Name:** Напр. "Основна BGN сметка", "EUR сметка"
- **Описание:** Допълнителна информация

4. Кликнете **Test IBAN** за валидация
5. Кликнете **Save**

#### Задаване на сметка по подразбиране

1. Отворете банковата сметка
2. Кликнете **Set as Default**
3. Тази сметка ще се избира автоматично в новите документи

#### Използване на банкова сметка в документ

При създаване на документ:

1. Изберете **Payment Method:** BANK_TRANSFER
2. Автоматично се появява поле **Bank Account**
3. Изберете сметка (по подразбиране е избрана default сметката)
4. Банковите данни ще се покажат в PDF-а на документа

---

## Проследяване на плащания

### Статус на плащане

Системата автоматично проследява статуса на плащане за всеки документ:

#### Автоматично платени документи

Документи с методи на плащане **CASH (В брой)** и **CARD (С карта)** автоматично се маркират като платени, защото плащането се извършва в момента на продажбата (съгласно Наредба Н-18 за касовите апарати).

#### Банкови преводи

Документи с метод **BANK_TRANSFER (Банков превод)** се считат за неплатени до момента, в който операторът ги маркира като платени.

### Маркиране като платено

От страницата **Документи**:

1. Намерете документа в списъка
2. В колоната **Плащане** ще видите:
   - **В брой** / **С карта** - автоматично платени (зелен chip)
   - **Неплатено** (червен chip) - за банкови преводи
3. Кликнете върху червения chip **Неплатено**
4. Появява се диалог за избор на дата на плащане
5. Изберете датата на получаване на превода
6. Кликнете **Потвърди**
7. Документът се маркира като **Платено DD.MM.YYYY**

### Визуализация в списъка

Колоната **Плащане** показва статуса с цветово кодиране:

| Статус | Цвят | Описание |
|--------|------|----------|
| В брой | Зелен | Платено в брой |
| С карта | Зелен | Платено с карта |
| Платено DD.MM.YYYY | Зелен | Банков превод получен |
| Неплатено | Червен | Очаква се банков превод |

### GraphQL API

```graphql
mutation MarkDocumentAsPaid($documentId: ID!, $paidAt: String) {
  markDocumentAsPaid(documentId: $documentId, paidAt: $paidAt) {
    id
    isPaid
    paidAt
  }
}
```

---

## PDF Генериране

### Как работи?

Системата генерира PDF документи **client-side** (във вашия браузър) с помощта на:
- **jsPDF** - JavaScript библиотека за генериране на PDF
- **html2canvas** - Преобразува HTML → изображение → PDF

### Генериране на PDF

От страницата с детайли на документ:

1. Кликнете бутона **Export PDF**
2. Изчакайте 1-2 секунди
3. PDF файлът ще се изтегли автоматично
4. Име на файла: `invoice-0000000001.pdf`

### Какво съдържа PDF-ът?

**Header (Горна част):**
- Лого на фирмата (ако е добавено)
- Заглавие: "ФАКТУРА" / "INVOICE"
- Номер на документа
- Дата на издаване

**Информация за продавача:**
- Име на фирмата
- ЕИК
- ДДС номер (ако е регистриран)
- Адрес
- Телефон, имейл

**Информация за купувача:**
- Име на клиента
- ЕИК/ДДС номер (ако е B2B)
- Адрес
- Телефон, имейл

**Таблица с артикули:**
- №
- Описание
- Количество
- Единица
- Единична цена
- ДДС %
- Обща цена

**Суми:**
- Междинна сума (без ДДС)
- ДДС сума (по ставки)
- Обща сума (с ДДС)
- Валута
- Левова равностойност (ако не е BGN)
- Валутен курс

**Плащане:**
- Метод на плащане
- Банкова сметка (IBAN, BIC, Банка)
- Срок на плащане

**Footer (Долна част):**
- Съставител
- Печат и подпис (ако са добавени)
- Долен текст (disclaimer и др.)

### Принтиране на документ

От страницата с детайли:

1. Кликнете бутона **Print**
2. Отваря се print preview
3. Изберете принтер
4. Кликнете **Print**

Или директно от PDF-а:
1. Генерирайте PDF
2. Отворете PDF файла
3. Принтирайте от PDF viewer-а

### Персонализиране на PDF

#### Добавяне на лого

1. Отидете на **Company Settings**
2. Секция **Branding**
3. Кликнете **Upload Logo**
4. Изберете изображение (PNG, JPG)
5. Препоръчва се: 300x100 px, прозрачен фон
6. Кликнете **Save**

Логото ще се показва в горната част на всички PDF-и.

#### Добавяне на печат и подпис

1. Отидете на **Company Settings** → **Branding**
2. Кликнете **Upload Stamp** (печат)
3. Кликнете **Upload Signature** (подпис)
4. Изберете изображения (PNG с прозрачен фон)
5. Кликнете **Save**

Печатът и подписът ще се показват в долната част на PDF-а.

#### Долен текст (Footer)

1. Отидете на **Company Settings**
2. Секция **Invoice Settings**
3. Поле **Footer Text (BG)**
4. Въведете текст, например:
   ```
   Благодарим за доверието!
   При забава на плащането се дължи законна лихва.
   ```
5. Кликнете **Save**

Текстът ще се показва в подножието на всички документи.

---

## Валидатор на документи

### Какво е валидаторът?

Валидаторът на документи е публична функция, която позволява на клиентите да проверят автентичността на получена фактура. Всеки документ в системата получава уникален **UUID (Universally Unique Identifier)**, който служи като цифров идентификатор/подпис.

### Как работи?

#### Уникален идентификатор (UUID)

При създаване на всеки документ, системата автоматично генерира уникален UUID:
- Формат: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- Уникален за всеки документ в системата
- Не може да се промени след създаване
- Показва се в долната част на печатния документ

#### Печатен документ

При печат или експорт на PDF, в долната част на документа се показва:

```
Съставил: Иван Иванов

Цифров идентификатор: a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

**Съставил** - взима се от настройките на фирмата (поле "Съставител на фактури")

### Използване на валидатора

#### За клиенти (без логин)

1. Отворете адрес `/verify` (напр. `https://вашият-домейн.com/verify`)
2. Въведете UUID от получената фактура
3. Кликнете **Провери документа**
4. Системата показва:
   - **Ако документът е валиден:**
     - Тип документ (Фактура, Кредитно известие и др.)
     - Номер на документа
     - Дата на издаване
     - Сума и валута
     - Име на издателя (фирмата)
     - ЕИК на издателя
     - Име на получателя (клиента)
   - **Ако документът не е намерен:**
     - Съобщение за грешка
     - Препоръка да се провери UUID

#### Достъп до валидатора

Валидаторът е достъпен по два начина:

1. **Директен URL:** `/verify`
2. **От входната страница:** Бутон "Валидатор на документи" под формата за логин

### Настройка на съставител

За да се показва име на съставител в документите:

1. Отидете на **Company** (Данни за фирмата)
2. Секция **Настройки за фактури**
3. Поле **Съставител на фактури**
4. Въведете името (напр. "Иван Иванов")
5. Кликнете **Запази промените**

Това име ще се показва във всички бъдещи документи.

### Сигурност

- UUID е криптографски сигурен (random UUID v4)
- Не разкрива информация за клиента или сумата преди проверка
- Не може да се познае или генерира
- Валидаторът показва само публична информация

### GraphQL API

За интеграции, валидаторът е достъпен чрез GraphQL:

```graphql
query VerifyDocument($uuid: String!) {
  verifyDocument(uuid: $uuid) {
    documentUuid
    documentNumber
    documentType
    issueDate
    totalAmount
    currencyCode
    companyName
    companyEik
    clientName
    isValid
  }
}
```

---

## Справки и отчети

### Достъп до справките

От страничното меню изберете **Справки**. Страницата съдържа два таба:

1. **Документи** - справка по документи
2. **Артикули** - справка по артикули

### Таб "Документи"

#### Филтри

- **Клиент** - изберете конкретен клиент (autocomplete)
- **Плащане** - Всички / Платени / Неплатени
- **От дата** - начална дата на периода
- **До дата** - крайна дата на периода
- **Тип документ** - Фактура / Кредитно известие / Дебитно известие / Проформа

#### Обобщени карти

- **Общо документи** - брой документи, отговарящи на филтрите
- **Обща сума** - сума на всички документи
- **Платено** (зелена карта) - сума на платените документи
- **Неплатено** (червена карта) - сума на неплатените документи

#### Таблица с резултати

| Колона | Описание |
|--------|----------|
| № | Пореден номер |
| Номер | Пълен номер на документа |
| Тип | Тип документ |
| Клиент | Име на клиента |
| Дата | Дата на издаване |
| Срок | Срок на плащане |
| Сума | Обща сума в лева |
| Статус | Чернова / Приключен |
| Плащане | Статус на плащане |

### Таб "Артикули"

Показва обобщена информация за продадени артикули за избрания период.

#### Филтри

- **Артикул** - изберете конкретен артикул (autocomplete)
- **Клиент** - изберете клиент (за да видите продажбите само към него)
- **От дата** - начална дата
- **До дата** - крайна дата

**Забележка:** В таб "Артикули" няма филтър за платено/неплатено, тъй като справката е насочена към анализ на продажбите по артикули.

#### Обобщени карти

- **Брой артикули** - брой различни артикули
- **Общо количество** (синя карта) - сумарно количество продадени бройки
- **Обща сума** (синя карта) - обща стойност на продажбите

#### Таблица с резултати

| Колона | Описание |
|--------|----------|
| № | Пореден номер |
| Код | Номер/код на артикула |
| Артикул | Име на артикула |
| Количество | Общо продадено количество |
| Сума | Обща стойност |
| Брой документи | В колко документа се среща |

Таблицата е сортирана по сума (най-продаваните артикули са отгоре).

### Експорт към Excel

От всеки таб можете да експортирате данните към Excel:

1. Приложете желаните филтри
2. Кликнете бутона **Експорт Excel**
3. Файлът се изтегля автоматично
4. Име на файла:
   - `Справка_Документи_YYYY-MM-DD.xlsx`
   - `Справка_Артикули_YYYY-MM-DD.xlsx`

Excel файлът съдържа:
- Всички колони от таблицата
- Последен ред с общи суми
- За документи: платено/неплатено разбивка

### HTML Печат

За печат на справката:

1. Приложете желаните филтри
2. Кликнете бутона **Печат**
3. Отваря се нов таб с форматирана HTML страница
4. Автоматично се отваря диалогът за печат
5. Изберете принтер и настройки
6. Кликнете **Print**

Печатната справка съдържа:
- Заглавие
- Приложени филтри
- Таблица с данни
- Обобщени суми
- Дата и час на отпечатване

### Примери за използване

#### Пример 1: Неплатени фактури за клиент

1. Отворете таб **Документи**
2. Изберете клиент от филтъра
3. Изберете **Плащане: Неплатени**
4. Виждате списък с неплатени фактури и общата сума

#### Пример 2: Продажби на артикул за месец

1. Отворете таб **Артикули**
2. Изберете артикул от филтъра
3. Задайте **От дата** и **До дата** за месеца
4. Виждате общото количество и сума за периода

#### Пример 3: Месечен отчет за всички клиенти

1. Отворете таб **Документи**
2. Задайте **От дата: 01.11.2025** и **До дата: 30.11.2025**
3. Кликнете **Експорт Excel**
4. Отворете Excel файла за детайлен анализ

---

## Управление на фирми

### Смяна на активна фирма (Multi-Company Support)

Системата поддържа работа с множество фирми. Всеки потребител може да има достъп до няколко фирми и да превключва между тях.

#### Какво е "Активна фирма"?

**Активната фирма** определя контекста на всички операции в системата:
- Всички документи, клиенти и артикули се филтрират по активната фирма
- Новосъздадени записи се асоциират с активната фирма
- Dashboard статистиките показват данни само за активната фирма
- Настройките на фирмата се отнасят за активната фирма

#### Как да сменя активната фирма?

**Метод 1: От хедъра**
1. В горната лента (header) виждате името на текущата активна фирма
2. Кликнете бутона **"Смени"** до името на фирмата
3. Ще бъдете пренасочени към страницата за избор на фирма

**Метод 2: От менюто**
1. В страничното меню кликнете **"Смени фирма"**
2. Ще се отвори страницата за избор на фирма

#### Страница за избор на фирма

На страницата `/select-company` виждате:

**Текуща активна фирма:**
- Показва се в зелен панел в горната част
- Показва името, ЕИК и ДДС номер

**Търсачка:**
- Полезна за потребители с достъп до много фирми (напр. счетоводители)
- Филтрира по: име, ЕИК, ДДС номер, град
- Показва броя намерени резултати

**Списък с фирми:**
- Всяка фирма се показва като карта
- Информация: име, ЕИК, ДДС номер, град
- Индикатори: ДДС регистрация, активна/неактивна
- Бутон **"Направи активна"** за смяна

#### Какво се случва при смяна на фирма?

1. Новата фирма се записва като активна (в localStorage)
2. Автоматично пренасочване към Dashboard
3. Всички данни се презареждат за новата фирма:
   - Dashboard статистики
   - Списък с документи
   - Списък с клиенти
   - Списък с артикули
   - Настройки на фирмата

#### Технически детайли

**Съхранение на активната фирма:**
- `localStorage.activeCompanyId` - съхранява ID на активната фирма
- `CompanyContext` - React context за достъп от всички компоненти
- Остава запомнена между сесиите

**Филтриране на данни:**
- Всички GraphQL заявки приемат `companyId` параметър
- Backend-ът филтрира резултатите по фирма
- Сигурност: потребителят има достъп само до фирми, за които е оторизиран

**Пример за използване в код:**
```javascript
import { useCompany } from '../context/CompanyContext';

const MyComponent = () => {
  const { activeCompanyId } = useCompany();

  const { data } = useQuery(GET_CLIENTS, {
    variables: { companyId: activeCompanyId }
  });

  // ...
};
```

---

### Профил на фирмата

Тук съдържа пълна информация за вашата фирма, която се показва в документите.

#### Основна информация

1. Отидете на **Company**
2. Секция **Basic Information**
3. Попълнете:

**Фирмени данни:**
- **Име (BG):** Официално име на фирмата на български
- **Име (EN):** Име на английски (за международни документи)
- **ЕИК:** Единен идентификационен код (9 или 13 цифри)
- **ДДС номер:** BG + 9-10 цифри (ако е ДДС регистрирана)
- **ДДС регистрация:** Дата на регистрация (ако е приложимо)

**Адрес:**
- Адрес 1
- Адрес 2 (опционално)
- Град
- Пощенски код
- Държава

**Контакти:**
- Телефон
- Email
- Уебсайт (опционално)

#### Subscription план

Виждате текущия си план:
- **FREE** - До 2 потребителя
- **PRO** - До 10 потребителя (30 лв/месец)
- **BUSINESS** - Unlimited потребители (70 лв/месец)
- **ENTERPRISE** - Custom (по договаряне)

За upgrade: Свържете се с поддръжката.

---

## Потребители и роли

### Система за автентикация (JWT)

Системата използва **JWT (JSON Web Token)** за автентикация. Това е модерен, stateless подход за сигурност.

#### Как работи JWT автентикацията?

1. **Логин:** Потребителят въвежда username и password
2. **Проверка:** Backend-ът проверява credentials срещу базата данни
3. **Токен:** При успех се генерира JWT токен (валиден 24 часа)
4. **Съхранение:** Токенът се съхранява в localStorage на браузъра
5. **Заявки:** Всяка заявка към API-то включва токена в Authorization header
6. **Валидация:** Backend-ът валидира токена при всяка заявка

#### Структура на JWT токена

Токенът съдържа:
- **Username** - потребителско име
- **Role** - роля (SUPER_ADMIN, ADMIN, USER, ACCOUNTANT)
- **Issued At** - кога е издаден
- **Expiration** - кога изтича (24 часа)

#### Сигурност

- Токените са криптографски подписани
- Не могат да бъдат манипулирани без secret key
- Автоматично изтичат след 24 часа
- При logout токенът се изтрива от браузъра

### Роли и права

Системата поддържа **Role-Based Access Control (RBAC)** с четири нива на достъп:

#### SUPER_ADMIN
- Супер администратор на системата
- Достъп до всички фирми
- Създаване и управление на фирми
- Global Settings
- **Създава се само чрез Linux скриптове**

**Технически права:** `ROLE_SUPER_ADMIN`

#### ADMIN
- Администратор на фирма
- Пълен достъп до данните на фирмата
- Управление на потребители
- Настройки на фирмата
- Създаване/редакция на всички документи

**Технически права:** `ROLE_ADMIN`

#### USER
- Обикновен потребител (фактурист)
- Създаване и редакция на документи
- Преглед на клиенти и артикули
- Експорт на PDF
- Ограничен достъп до настройки

**Технически права:** `ROLE_USER`

#### ACCOUNTANT
- Счетоводител
- Преглед на всички документи
- Създаване на документи
- Експорт и отчети
- Без достъп до настройки на фирмата

**Технически права:** `ROLE_ACCOUNTANT`

### Матрица на правата

| Функция | SUPER_ADMIN | ADMIN | USER | ACCOUNTANT |
|---------|-------------|-------|------|------------|
| Създаване на фирми | ✅ | ❌ | ❌ | ❌ |
| Управление на фирми | ✅ | ❌ | ❌ | ❌ |
| Настройки на фирма | ✅ | ✅ | ❌ | ❌ |
| Управление на потребители | ✅ | ✅ | ❌ | ❌ |
| Създаване на документи | ✅ | ✅ | ✅ | ✅ |
| Редакция на документи | ✅ | ✅ | ✅ | ✅ |
| Изтриване на документи | ✅ | ✅ | ❌ | ❌ |
| Управление на клиенти | ✅ | ✅ | ✅ | ❌ |
| Управление на артикули | ✅ | ✅ | ✅ | ❌ |
| Справки и отчети | ✅ | ✅ | ✅ | ✅ |
| Експорт на данни | ✅ | ✅ | ✅ | ✅ |

### Техническа имплементация

#### Backend (Spring Security)

```java
// SecurityConfig.java
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    // JWT филтър проверява всяка заявка
    http.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter.class);
}

// UserService.java - Зареждане на потребител с роли
public UserDetails loadUserByUsername(String username) {
    User user = userRepository.findByUsername(username);
    SimpleGrantedAuthority authority = new SimpleGrantedAuthority("ROLE_" + user.getRole().name());
    return new User(user.getUsername(), user.getPassword(), Collections.singletonList(authority));
}
```

#### Frontend (React Context)

```javascript
// AuthContext.jsx
const login = async (authResponse) => {
    const { token } = authResponse;
    setToken(token);
    localStorage.setItem('authToken', token);
    await fetchUser(token);  // Зарежда данните за потребителя
};

// Apollo Client - Добавя токена към всяка заявка
const authLink = setContext((_, { headers }) => {
    const token = localStorage.getItem('authToken');
    return {
        headers: {
            ...headers,
            authorization: token ? `Bearer ${token}` : "",
        }
    };
});
```

### API Endpoints

#### Логин

```
POST /authenticate
Content-Type: application/json

{
    "username": "admin",
    "password": "password123"
}

Response:
{
    "token": "eyJhbGciOiJIUzUxMiJ9..."
}
```

#### GraphQL заявки с автентикация

```
POST /graphql
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...
Content-Type: application/json

{
    "query": "query { me { id username role } }"
}
```

### Възстановяване на парола

#### Процес

1. Потребителят кликва "Забравена парола" на login страницата
2. Въвежда имейл адреса си
3. Системата изпраща токен за възстановяване (валиден 1 час)
4. Потребителят въвежда токена
5. Въвежда нова парола
6. Паролата се обновява

#### GraphQL мутации

```graphql
# Стъпка 1: Заявка за reset
mutation {
    requestPasswordReset(input: { email: "user@example.com" }) {
        success
        message
    }
}

# Стъпка 2: Валидация на токена
mutation {
    validateResetToken(token: "abc123") {
        isValid
        email
        expiresAt
    }
}

# Стъпка 3: Смяна на паролата
mutation {
    resetPassword(input: { token: "abc123", newPassword: "newPass123" }) {
        success
        message
    }
}
```

**Забележка:** За работа на възстановяването на парола е необходима SMTP конфигурация.

### Управление на потребители

#### Създаване на потребител (от ADMIN)

1. Отидете на **Users**
2. Кликнете **Add User**
3. Попълнете:
   - Username (уникално)
   - Password (минимум 8 знака)
   - Email
   - Role: ADMIN / USER / ACCOUNTANT
   - Company: Вашата фирма (автоматично избрана)
4. Кликнете **Create**

#### Създаване на SUPER_ADMIN (от Linux)

```bash
cd reset
./create-super-admin.sh
```

Следвайте инструкциите.

#### Редактиране на потребител

1. Отидете на **Users**
2. Кликнете върху потребителя
3. Кликнете **Edit**
4. Променете данните
5. Кликнете **Save**

#### Деактивиране на потребител

1. Отворете потребителя
2. Кликнете **Deactivate**
3. Потребителят няма да може да влезе в системата

За активиране отново:
1. Филтрирайте за "Inactive" потребители
2. Отворете потребителя
3. Кликнете **Activate**

#### Смяна на парола

**От самия потребител:**
1. Кликнете на името си (горе-дясно)
2. **Change Password**
3. Въведете стара парола
4. Въведете нова парола
5. Потвърдете нова парола
6. Кликнете **Save**

**От администратор:**
1. Отворете потребителя
2. Кликнете **Reset Password**
3. Въведете нова парола
4. Кликнете **Save**

### Password Reset (Забравена парола)

1. От login страницата кликнете **Forgot Password**
2. Въведете вашия email
3. Кликнете **Send Reset Link**
4. Проверете имейла си
5. Кликнете на линка в имейла
6. Въведете нова парола
7. Кликнете **Reset Password**
8. Влезте със новата парола

**Забележка:** Работи само ако SMTP е конфигуриран.

---

## Dashboard и статистики

### Преглед на Dashboard

Dashboard страницата показва ключови метрики и последна активност.

#### Метрики (Cards)

**Общо клиенти:**
- Брой активни клиенти
- Link към Clients страница

**Общо документи:**
- Брой всички документи
- Link към Documents страница

**Общ приход:**
- Сума на всички FINAL документи
- В BGN

**Приключени документи:**
- Брой FINAL документи
- % от общо документи

**Просрочени документи:**
- Брой документи след падежа
- Изискват внимание

#### Последни документи

Таблица с последните 5 документа:
- Номер
- Тип
- Клиент
- Дата
- Сума
- Статус

Кликнете върху документ за детайли.

#### Месечни приходи (Графика)

Показва приходите за последните 12 месеца:
- Bar chart или Line chart
- По месеци
- В BGN
- Само FINAL документи

### Филтриране на статистики

Може да филтрирате по:
- Период (от-до)
- Тип документ
- Клиент
- Статус

---

**Следващо:** [GraphQL API документация](./03-graphql-api.md)
