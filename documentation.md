# Документация: Интеграция на многовалутна поддръжка - Bash Inv Web Електронно Фактуриране

## Цел на задачата

Основната цел беше да се разшири съществуващата система за електронно фактуриране, така че да поддържа документи (фактури, кредитни/дебитни известия) в различни валути. Системата трябва автоматично да изтегля актуални валутни курсове от Европейската централна банка (ЕЦБ) и да изчислява сумите в левовия им еквивалент (BGN) за счетоводни цели.

## Изпълнени стъпки

### 1. Промени в базата данни и модела на данните

За да поддържаме валути и курсове, създадохме нови таблици и разширихме съществуващите:

- **`Currency.java`**: Създадохме ново ентити `Currency`, което съхранява информация за отделните валути (ISO код, име, символ). Това ни позволява да имаме централизиран регистър на поддържаните валути.
- **`ExchangeRate.java`**: Създадохме ентити `ExchangeRate` за съхранение на исторически данни за валутните курсове. Всеки запис съдържа валута, дата, курс и базова валута (спрямо която е курсът - EUR).
- **`Document.java`**: Модифицирахме основното ентити `Document`, като:
  - Добавихме връзка към `Currency`, за да се знае в каква валута е издаден документът.
  - Добавихме поле `exchangeRate` за съхранение на конкретния курс към датата на издаване.
  - Добавихме нови полета за суми: `subtotalAmount`, `vatAmount`, `totalAmountWithVat`.
  - Добавихме и полета за левовата равностойност на всяка от тези суми (`subtotalAmountBgn`, `vatAmountBgn`, `totalAmountWithVatBgn`).

### 2. Конфигурация на проекта

- **`pom.xml`**: 
  - Добавихме зависимостта `org.projectlombok:lombok`, за да се справим с грешки при компилация и да намалим boilerplate кода в моделите.
  - Добавихме `spring-boot-starter-webflux` за достъп до `WebClient`, необходим за HTTP заявки към ЕЦБ.
  - Добавихме `jackson-dataformat-xml` за лесно парсване на XML отговора от ЕЦБ.

### 3. Разработка на бекенд логиката

Разработихме няколко нови сървиса и обновихме съществуващи, за да имплементираме функционалността:

- **`CurrencyRepository` и `ExchangeRateRepository`**: Създадохме нови Spring Data JPA репозиторита за достъп до данните в новите таблици.

- **`EcbService.java`**: 
  - Създадохме нов сървис, който е отговорен изцяло за комуникацията с ЕЦБ.
  - Имплементирахме метод `fetchAndSaveRates`, който се изпълнява автоматично всеки ден благодарение на анотацията `@Scheduled`.
  - Методът изтегля XML с дневните курсове, парсва го и записва всеки курс в таблицата `exchange_rates`.

- **`ExchangeRateService.java`**: 
  - Създадохме този сървис, за да капсулираме логиката за намиране на валутен курс за конкретна валута и дата. Това разделя отговорностите и прави кода по-чист.

- **`DocumentService.java`**: 
  - Обновихме ключовия метод `createDocument`.
  - Премахнахме старата логика и имплементирахме нова, която:
    1. Приема `currencyCode` като входен параметър.
    2. Намира съответната `Currency` от базата данни.
    3. Чрез `ExchangeRateService` намира нужния валутен курс за датата на документа (спрямо EUR).
    4. Изчислява кръстосан курс към BGN, използвайки EUR като опорна валута.
    5. Записва в документа както оригиналните суми във валута, така и техните левови равностойности.

- **`BackendApplication.java`**: Добавихме анотацията `@EnableScheduling`, за да активираме автоматичното изпълнение на задачи.

### 4. Промени в API

- **`schema.graphqls`**: Разширихме GraphQL схемата, като добавихме поле `currencyCode` към `CreateDocumentInput`.
- **`CreateDocumentInput.java`**: Обновихме съответното DTO, за да може да приема новия параметър от клиента.

## Резултат

В резултат на тези промени, системата вече е способна да:
- Създава документи в различни валути (EUR, USD, BGN и др.).
- Автоматично поддържа актуална база данни с валутни курсове от ЕЦБ.
- Изчислява и съхранява коректно левовата равностойност на всеки документ, което е задължително за българското счетоводство.

Системата е готова за тестване и последващи подобрения, като например по-добро управление на грешки и добавяне на повече валути по подразбиране.
